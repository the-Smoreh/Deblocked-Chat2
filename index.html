<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Deblocked Chat</title>

<link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap" rel="stylesheet">

<style>
    body {
        margin: 0;
        font-family: Arial, sans-serif;

        /* Darker animated gradient */
        background: linear-gradient(135deg, #1a1a1a, #2a2a2a, #3a3a3a);
        background-size: 400% 400%;
        animation: bgMove 30s ease infinite;

        height: 100vh;
        display: flex;
        justify-content: center;
        align-items: flex-start;
        padding-top: 40px;
    }

    @keyframes bgMove {
        0% { background-position: 0% 0%; }
        50% { background-position: 100% 100%; }
        100% { background-position: 0% 0%; }
    }

    #chat-container {
        width: 480px;
        backdrop-filter: blur(12px);
        background: rgba(255, 255, 255, 0.55);
        border-radius: 16px;
        padding: 20px;
        box-shadow: 0 0 18px rgba(0,0,0,0.15);
    }

    #header {
        text-align: center;
        margin-bottom: 15px;
        font-family: "Fredoka", sans-serif;
    }

    #header h1 {
        margin: 0;
        font-size: 28px;
        font-weight: 600;
    }

    #header p {
        margin: 0;
        margin-top: 4px;
        font-size: 14px;
        opacity: 0.7;
    }

    #messages {
        height: 320px;
        overflow-y: auto;
        border-radius: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.65);
        border: 1px solid #ddd;
        margin-bottom: 15px;
    }

    .msg {
        margin-bottom: 10px;
        padding: 8px 12px;
        border-radius: 8px;
        background: #fff;
        border: 1px solid #eee;
        word-wrap: break-word;
    }

    .msg img {
        max-width: 100%;
        border-radius: 6px;
        margin-top: 6px;
    }

    #inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
    }

    input, button {
        padding: 10px;
        border-radius: 6px;
        border: 1px solid #ccc;
        font-size: 15px;
    }

    button {
        background: #4a90e2;
        color: white;
        cursor: pointer;
        border: none;
    }

    button:hover {
        background: #357ac9;
    }

    #image-preview {
        max-width: 100%;
        margin-top: 8px;
        display: none;
        border-radius: 8px;
    }
</style>
</head>
<body>

<div id="chat-container">

    <div id="header">
        <h1>Deblocked Chat</h1>
        <p>Online: <span id="online-count">0</span></p>
    </div>

    <div id="messages"></div>

    <img id="image-preview">

    <div id="inputs">
        <input id="username" placeholder="Enter username">
        <input id="message" placeholder="Enter message">

        <input type="file" id="image-upload" accept="image/*">

        <button id="send">Send Message</button>
        <button id="send-image">Send Image</button>
    </div>
</div>

<script>
    const protocol = window.location.protocol === "https:" ? "wss" : "ws";
    const ws = new WebSocket(`${protocol}://${window.location.host}`);

    const messages = document.getElementById("messages");
    const usernameInput = document.getElementById("username");
    const messageInput = document.getElementById("message");
    const sendBtn = document.getElementById("send");
    const sendImageBtn = document.getElementById("send-image");
    const imageUpload = document.getElementById("image-upload");
    const imagePreview = document.getElementById("image-preview");
    const onlineCount = document.getElementById("online-count");

    let usernameLocked = false;
    let selectedImage = null;

    // Preview image
    imageUpload.onchange = () => {
        const file = imageUpload.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = () => {
            selectedImage = reader.result;
            imagePreview.src = selectedImage;
            imagePreview.style.display = "block";
        };
        reader.readAsDataURL(file);
    };

    // Send text
    sendBtn.onclick = () => {
        const username = usernameInput.value.trim();
        const message = messageInput.value.trim();

        if (!username || !message) return;

        if (!usernameLocked) {
            usernameInput.disabled = true;
            usernameLocked = true;
        }

        ws.send(JSON.stringify({ type: "text", username, message }));
        messageInput.value = "";
    };

    // Send image
    sendImageBtn.onclick = () => {
        const username = usernameInput.value.trim();
        if (!username || !selectedImage) return;

        if (!usernameLocked) {
            usernameInput.disabled = true;
            usernameLocked = true;
        }

        ws.send(JSON.stringify({ type: "image", username, image: selectedImage }));

        selectedImage = null;
        imagePreview.style.display = "none";
        imageUpload.value = "";
    };

    // Receive messages
    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        if (data.type === "online") {
            onlineCount.textContent = data.count;
            return;
        }

        if (data.type === "history") {
            data.history.forEach(msg => renderMessage(msg));
            return;
        }

        renderMessage(data);
    };

    function renderMessage(data) {
        const div = document.createElement("div");
        div.className = "msg";

        if (data.type === "text") {
            div.innerHTML = `<strong style="color:${data.color}">${data.username}:</strong> ${data.message}`;
        }

        if (data.type === "image") {
            div.innerHTML = `<strong style="color:${data.color}">${data.username}:</strong><br><img src="${data.image}">`;
        }

        messages.appendChild(div);
        messages.scrollTop = messages.scrollHeight;
    }
</script>

</body>
</html>
